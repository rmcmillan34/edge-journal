{% extends "base.html" %}

{% block title %}{{ month_name }} {{ year }} - Trading Report{% endblock %}

{% block content %}
<div class="container">
    <!-- Cover Page -->
    <div class="cover-page">
        <div class="cover-title">Trading Performance Report</div>
        <div class="cover-subtitle">{{ month_name }} {{ year }}</div>
        <div class="cover-meta">
            <p>Generated: {{ generated_at }}</p>
        </div>
    </div>

    <!-- Executive Summary -->
    <div class="section no-break">
        <h1>Executive Summary</h1>

        <!-- Performance Metrics -->
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-label">Total P&L</div>
                <div class="metric-value {% if metrics.total_pnl > 0 %}positive{% elif metrics.total_pnl < 0 %}negative{% endif %}">
                    ${{ "%.2f"|format(metrics.total_pnl) }}
                </div>
            </div>

            <div class="metric-card">
                <div class="metric-label">Total Trades</div>
                <div class="metric-value">{{ metrics.total_trades }}</div>
            </div>

            <div class="metric-card">
                <div class="metric-label">Win Rate</div>
                <div class="metric-value">{{ "%.1f"|format(metrics.win_rate * 100) }}%</div>
            </div>

            <div class="metric-card">
                <div class="metric-label">Avg Win</div>
                <div class="metric-value positive">${{ "%.2f"|format(metrics.avg_win) }}</div>
            </div>

            <div class="metric-card">
                <div class="metric-label">Avg Loss</div>
                <div class="metric-value negative">${{ "%.2f"|format(metrics.avg_loss) }}</div>
            </div>

            <div class="metric-card">
                <div class="metric-label">Profit Factor</div>
                <div class="metric-value">{{ "%.2f"|format(metrics.profit_factor) }}</div>
            </div>

            <div class="metric-card">
                <div class="metric-label">Largest Win</div>
                <div class="metric-value positive">${{ "%.2f"|format(metrics.largest_win) }}</div>
            </div>

            <div class="metric-card">
                <div class="metric-label">Largest Loss</div>
                <div class="metric-value negative">${{ "%.2f"|format(metrics.largest_loss) }}</div>
            </div>

            <div class="metric-card">
                <div class="metric-label">Avg P&L/Trade</div>
                <div class="metric-value {% if metrics.avg_pnl_per_trade > 0 %}positive{% elif metrics.avg_pnl_per_trade < 0 %}negative{% endif %}">
                    ${{ "%.2f"|format(metrics.avg_pnl_per_trade) }}
                </div>
            </div>
        </div>

        <!-- Equity Curve -->
        {% if equity_chart %}
        <div class="chart-container">
            <h3>Equity Curve</h3>
            <img src="{{ equity_chart }}" alt="Equity Curve" />
        </div>
        {% endif %}

        <!-- Trading Calendar -->
        {% if calendar_html %}
        <div class="calendar-container">
            <h3>Trading Calendar</h3>
            {{ calendar_html | safe }}
        </div>
        {% endif %}
    </div>

    <!-- Trade List -->
    <div class="section page-break">
        <h2>Trade List</h2>

        {% if trades %}
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Symbol</th>
                    <th>Side</th>
                    <th class="text-right">Qty</th>
                    <th class="text-right">Entry</th>
                    <th class="text-right">Exit</th>
                    <th class="text-right">P&L</th>
                </tr>
            </thead>
            <tbody>
                {% for trade in trades %}
                <tr>
                    <td>{{ trade.open_time_utc.strftime('%Y-%m-%d %H:%M') if trade.open_time_utc else 'N/A' }}</td>
                    <td>{{ trade.symbol }}</td>
                    <td>
                        {% if trade.side == 'long' %}
                        <span class="badge badge-info">LONG</span>
                        {% else %}
                        <span class="badge badge-danger">SHORT</span>
                        {% endif %}
                    </td>
                    <td class="text-right">{{ "%.4f"|format(trade.qty_units) if trade.qty_units else '-' }}</td>
                    <td class="text-right">${{ "%.5f"|format(trade.entry_price) if trade.entry_price else '-' }}</td>
                    <td class="text-right">${{ "%.5f"|format(trade.exit_price) if trade.exit_price else '-' }}</td>
                    <td class="text-right {% if trade.net_pnl and trade.net_pnl > 0 %}trade-win{% elif trade.net_pnl and trade.net_pnl < 0 %}trade-loss{% endif %}">
                        {% if trade.net_pnl %}${{ "%.2f"|format(trade.net_pnl) }}{% else %}-{% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-muted">No trades found for this period.</p>
        {% endif %}
    </div>

    <!-- Per-Account Breakdown (if grouped mode) -->
    {% if account_separation_mode == 'grouped' and account_groups %}
    <div class="section page-break">
        <h2>Performance by Account</h2>

        {% for group in account_groups %}
        <div class="account-group no-break">
            <h3>{{ group.account_name }}</h3>

            <!-- Account Metrics -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-label">Total P&L</div>
                    <div class="metric-value {% if group.metrics.total_pnl > 0 %}positive{% elif group.metrics.total_pnl < 0 %}negative{% endif %}">
                        ${{ "%.2f"|format(group.metrics.total_pnl) }}
                    </div>
                </div>

                <div class="metric-card">
                    <div class="metric-label">Total Trades</div>
                    <div class="metric-value">{{ group.metrics.total_trades }}</div>
                </div>

                <div class="metric-card">
                    <div class="metric-label">Win Rate</div>
                    <div class="metric-value">{{ "%.1f"|format(group.metrics.win_rate * 100) }}%</div>
                </div>

                <div class="metric-card">
                    <div class="metric-label">Profit Factor</div>
                    <div class="metric-value">{{ "%.2f"|format(group.metrics.profit_factor) }}</div>
                </div>
            </div>

            <!-- Account Trade List -->
            <table style="margin-top: 1rem;">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Symbol</th>
                        <th>Side</th>
                        <th class="text-right">Qty</th>
                        <th class="text-right">Entry</th>
                        <th class="text-right">Exit</th>
                        <th class="text-right">P&L</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trade in group.trades %}
                    <tr>
                        <td>{{ trade.open_time_utc.strftime('%Y-%m-%d %H:%M') if trade.open_time_utc else 'N/A' }}</td>
                        <td>{{ trade.symbol }}</td>
                        <td>
                            {% if trade.side == 'long' %}
                            <span class="badge badge-info">LONG</span>
                            {% else %}
                            <span class="badge badge-danger">SHORT</span>
                            {% endif %}
                        </td>
                        <td class="text-right">{{ "%.4f"|format(trade.qty_units) if trade.qty_units else '-' }}</td>
                        <td class="text-right">${{ "%.5f"|format(trade.entry_price) if trade.entry_price else '-' }}</td>
                        <td class="text-right">${{ "%.5f"|format(trade.exit_price) if trade.exit_price else '-' }}</td>
                        <td class="text-right {% if trade.net_pnl and trade.net_pnl > 0 %}trade-win{% elif trade.net_pnl and trade.net_pnl < 0 %}trade-loss{% endif %}">
                            {% if trade.net_pnl %}${{ "%.2f"|format(trade.net_pnl) }}{% else %}-{% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Trade Details (if include_screenshots and attachments exist) -->
    {% if include_screenshots %}
    <div class="section">
        <h2>Trade Details</h2>
        {% for trade in trades %}
        {% if trade.notes_md or trade.post_analysis_md or trade_attachments.get(trade.id) %}
        <div class="trade-detail" style="page-break-inside: avoid; margin-bottom: 2rem;">
            <h3>{{ trade.symbol }} - {{ trade.open_time_utc.strftime('%Y-%m-%d') if trade.open_time_utc else 'N/A' }}
                <span style="font-size: 0.8rem; color: var(--text-muted);">({{ trade.side.upper() }}, P&L: ${{ "%.2f"|format(trade.net_pnl) if trade.net_pnl else '0.00' }})</span>
            </h3>

            {% if trade.notes_md %}
            <h4>Pre-Trade Notes</h4>
            <div class="markdown-content">
                {{ trade.notes_md }}
            </div>
            {% endif %}

            {% if trade.post_analysis_md %}
            <h4>Post-Trade Analysis</h4>
            <div class="markdown-content">
                {{ trade.post_analysis_md }}
            </div>
            {% endif %}

            {% if trade_attachments.get(trade.id) %}
            <h4>Screenshots ({{ trade_attachments[trade.id]|length }})</h4>
            {% for attachment in trade_attachments[trade.id] %}
            <div style="margin-bottom: 1rem; page-break-inside: avoid;">
                <p style="margin: 0.25rem 0; font-size: 0.9rem;">
                    <strong>{{ attachment.filename }}</strong>
                    {% if attachment.caption %} - {{ attachment.caption }}{% endif %}
                </p>
                {% if attachment.is_image and attachment.data_uri %}
                <div style="text-align: center; margin-top: 0.5rem;">
                    <img src="{{ attachment.data_uri }}" alt="{{ attachment.filename }}" style="max-width: 100%; max-height: 400px; border: 1px solid var(--border); border-radius: 4px;" />
                </div>
                {% endif %}
            </div>
            {% endfor %}
            {% endif %}
        </div>
        {% endif %}
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endblock %}
